<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/dc/1.6.0/dc.css">
    <link rel="stylesheet" href="//api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css">
    <style type="text/css">
      #data-table {
        width: 100%;
        height: 100%;
      }

      #hexbin-map {
        width: 100%;
        height: 300px;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
      }

      .map {
        position: relative;
        overflow: hidden;
      }

      .layer {
        position: absolute;
      }

      .tile {
        pointer-events: none;
        position: absolute;
        width: 256px;
        height: 256px;
      }

      .stations {
        width: 100%;
        height: 100%;
      }

      .station {
        opacity: 0.5;
      }
    </style>
  <body>
    <div id="viz" style="display:none;">
      <div id="hexbin-map"></div>
      <div class="container">
        <div class="row">
          <div class="col-sm-12" id="data-count">
            <p><strong class="filter-count"></strong> selected out of <strong class="total-count"></strong> records</p>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-2" id="month-chart">
            <strong>Month</strong>
            <a class="reset" href="javascript:charts.month.filterAll();dc.redrawAll('journeys');" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div class="col-sm-2" id="day-chart">
            <strong>Day</strong>
            <a class="reset" href="javascript:charts.day.filterAll();dc.redrawAll('journeys');" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div class="col-sm-4" id="hours-chart">
            <strong>Start Time</strong>
            <span class="filter"></span>
            <a class="reset" href="javascript:charts.hours.filterAll();dc.redrawAll('journeys');" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
          <div class="col-sm-4" id="duration-chart">
            <strong>Duration (min)</strong>
            <span class="filter"></span>
            <a class="reset" href="javascript:charts.duration.filterAll();dc.redrawAll('journeys');" style="display:none;">reset</a>
            <div class="clearfix"></div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12">
            <table id="data-table" class="table table-condensed table-hover"></table>
          </div>
        </div>
      </div>
    </div>

    <script src="//api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/2.0.1/spin.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.js"></script>
    <!--<script src='http://d3js.org/d3.geo.tile.v0.min.js'></script>-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.7/crossfilter.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dc/1.6.0/dc.js"></script>
    <script src="d3.hexbin.v0.min.js"></script>
    <script src="hexbin.js"></script>
    <!--<script src="/d3-map-tiles.js"></script>-->
    <script>
      // Constants
      var daysOfWeek = [ 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun' ];
      var months = [ 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec' ];
      var margins = { top: 10, right: 10, bottom: 30, left: 40 };
      var height = 150, width = 360;

      // Globals
      var charts = {}, dimensions, journeys, map, stations, stationsA = [];

      var spinner = new Spinner().spin();
      document.body.appendChild(spinner.el);

      d3.json('/data/stations.json', function(err, json) {
        if (err) return window.alert(err);
        stations = json;

        for (var i in stations) stationsA.push(stations[i]);

        // After displaying, setup the map
        map = L.mapbox.map('map', 'conveyal.gepida3i', {
          touchZoom: false,
          scrollWheelZoom: false
        }).setView([38.8399874, -77.0911667], 11);

        // Generate Hexbins
        map.on('viewreset', function() {
          generateHexbins(map, dimensions);
        });

        d3.csv('/data/2014-1st-quarter.processed.csv', parseCSVRow, processRows);
      });

      function processRows(err, rows) {
        if (err) return window.alert(err);

        journeys = crossfilter(rows);
        dimensions = createDimensions(journeys);

        charts.count = dc.dataCount('#data-count', 'journeys')
          .dimension(journeys)
          .group(dimensions.all);

        charts.month = dc.pieChart('#month-chart', 'journeys')
          .height(height)
          .label(function(d) { return months[d.data.key]; })
          .dimension(dimensions.byMonth)
          .group(dimensions.byMonth.group());

        charts.day = dc.pieChart('#day-chart', 'journeys')
          .height(height)
          .label(function(d) { return daysOfWeek[d.data.key]; })
          .dimension(dimensions.byDay)
          .group(dimensions.byDay.group());

        charts.hours = dc.barChart('#hours-chart', 'journeys')
          .height(height)
          .width(width)
          .margins(margins)
          .x(d3.scale.linear().domain([0, 23]))
          .elasticY(true)
          .round(Math.round)
          .dimension(dimensions.byHour)
          .group(dimensions.byHour.group());

        charts.duration = dc.lineChart('#duration-chart', 'journeys')
          .height(height)
          .width(width)
          .margins(margins)
          .x(d3.scale.linear().domain([0, 60, 200]))
          .elasticY(true)
          .round(Math.round)
          .dimension(dimensions.byDuration)
          .group(dimensions.byDuration.group(function(d) { return Math.floor(d); }));

        /* Data table */
        charts.table = dc.dataTable('#data-table', 'journeys')
          .columns(getTableColumns())
          .dimension(dimensions.byDate)
          .group(function(d) {
            return d.start_time.toDateString();
          })
          .sortBy(function(d) {
            return d.start_time.valueOf();
          })
          .size(25);

        dc.renderAll('journeys');
        document.getElementById('viz').style.display = 'block';

        map = mapTiles(document.getElementById('hexbin-map'))
        var stationBounds = getStationBounds(stations);
        map.to(stationBounds[0], stationBounds[1]);

        //
        projectStationsToMap(stations, map);

        spinner.stop();
      }

      function createDimensions(j) {
        return {
          all: j.groupAll(),
          byDate: j.dimension(function(d) { return d.start_time.valueOf(); }),
          byDay: j.dimension(function(d) { return d.start_time.getDay(); }),
          byDuration: j.dimension(function(d) { return d.duration / 60; }),
          byHour: j.dimension(function(d) { return d.start_time.getHours(); }),
          byMonth: j.dimension(function(d) { return d.start_time.getMonth(); })
        };
      }

      var id = 0;
      function parseCSVRow(d) {
        return {
          start_time: new Date(+d.start_time),
          start_terminal: +d.start_station,
          duration: +d.duration,
          end_terminal: +d.end_station,
          bike: d.bike
        };
      }

      function getTableColumns() {
        return [
          function(d) {
            return d.start_time.toLocaleTimeString();
          },
          function(d) {
            return stations[d.start_terminal].name;
          },
          function(d) {
            return (d.duration / 60).toFixed(1) + ' min';
          },
          function(d) {
            return stations[d.end_terminal]
              ? stations[d.end_terminal].name
              : d.end_terminal;
          },
          function(d) {
            return d.bike;
          }
        ]
      }

      function getStationBounds(stations) {
        // For DC area
        var nw = [ Infinity, -Infinity ];
        var se = [ -Infinity, Infinity ];

        for (var terminal in stations) {
          var ll = stations[terminal].coords;
          if (ll[0] < nw[0]) nw[0] = ll[0];
          if (ll[1] > nw[1]) nw[1] = ll[1];
          if (ll[0] > se[0]) se[0] = ll[0];
          if (ll[1] < se[1]) se[1] = ll[1];
        }

        return [ nw, se ];
      }

      function projectStationsToMap(stations, map) {
        /*var el = d3.select('.map')
          .insert('svg', '.layer')
          .attr('class', 'stations');

        for (var i = 0; i < stationsA.length; i++) stationsA[i].projected = map.projection(stationsA[i].coords);

        el.selectAll('.station')
          .data(stationsA, function(d) { return d.terminal; })
          .enter()
          .append('circle')
          .attr('class', 'station')
          .attr('r', '2')
          .attr('cx', function(d) {
            return d.projected[0];
          })
          .attr('cy', function(d) {
            return d.projected[1];
          });*/

      }
    </script>
  </body>
</html>